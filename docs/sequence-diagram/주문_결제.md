# 주문 / 결제 시퀀스 다이어그램

## 개요

이 다이어그램은 사용자가 모바일/웹 앱을 통해 상품을 주문하고 결제하는 전체 프로세스의 흐름을 보여줍니다. 주문 서비스, 상품 서비스, 잔액 서비스, 쿠폰 서비스 등 여러 마이크로서비스 간의 상호작용과 데이터베이스와의 연동, 그리고 오류 처리 시나리오를 포함합니다.

## 시퀀스 다이어그램

```plantuml
@startuml
title 주문 / 결제

actor 사용자 as User
participant "모바일/웹 앱" as Client
participant "주문 서비스" as OrderService
participant "상품 서비스" as ProductService
participant "잔액 서비스" as BalanceService
participant "쿠폰 서비스" as CouponService
participant "주문 저장소 (DB)" as OrderDB
participant "상품 저장소 (DB)" as ProductDB
participant "잔액 저장소 (DB)" as BalanceDB
participant "사용자 쿠폰 저장소 (DB)" as UserCouponDB
participant "데이터 플랫폼 어댑터" as DataPlatformAdapter
participant "데이터 분석 플랫폼" as DataPlatform

User -> Client: 상품 주문 요청 (userId, items: [{productId, quantity}], [couponId])
Client -> OrderService: POST /orders \n(userId, items, [couponId])
activate OrderService

note over OrderService, UserCouponDB
  **DB 트랜잭션 시작:**
  주문 생성, 재고 감소, 잔액 차감, 쿠폰 사용 처리
  모든 작업은 하나의 원자적인 단위로 처리 (ACID 보장)
end note

group **주문 처리 메인 흐름**
  ' 1. 주문 상품별 재고 및 유효성 확인
  loop 각 주문 상품 (item in items)
    OrderService -> ProductService: 상품 정보 및 재고 확인 (productId, quantity)
    activate ProductService
    ProductService --> OrderService: 상품 정보 및 현재 재고 반환
    deactivate ProductService

    alt 재고 부족 또는 상품 정보 불일치
      OrderService --> Client: HTTP 409 Conflict \n{status: "FAIL", code: "PRODUCT_OUT_OF_STOCK", message: "재고가 부족하거나 유효하지 않은 상품이 있습니다."}
      note right of OrderService: 트랜잭션 롤백
      deactivate OrderService
      Client --> User: "주문 실패" 메시지
      return
    end
  end

  ' 2. 쿠폰 유효성 검사 및 할인 금액 계산 (선택 사항)
  alt 쿠폰이 있는 경우
    OrderService -> CouponService: 쿠폰 유효성 검사 및 사용 가능 여부 확인 (userId, couponId)
    activate CouponService
    CouponService --> OrderService: 쿠폰 정보 (할인율/금액, 사용 가능 여부) 반환
    deactivate CouponService

    alt 쿠폰 유효하지 않음 (만료, 이미 사용됨 등)
      OrderService --> Client: HTTP 400 Bad Request \n{status: "FAIL", code: "COUPON_INVALID", message: "유효하지 않거나 사용할 수 없는 쿠폰입니다."}
      note right of OrderService: 트랜잭션 롤백
      deactivate OrderService
      Client --> User: "주문 실패" 메시지
      return
    end
  end

  ' 3. 사용자 잔액 조회 및 결제 금액 확인
  OrderService -> BalanceService: 사용자 잔액 조회 (userId)
  activate BalanceService
  BalanceService --> OrderService: 현재 잔액 반환 (currentBalance)
  deactivate BalanceService

  OrderService -> OrderService: 총 주문 금액 및 할인 금액 계산 (finalAmount)

  alt 잔액 부족
    OrderService --> Client: HTTP 402 Payment Required \n{status: "FAIL", code: "INSUFFICIENT_BALANCE", message: "잔액이 부족합니다."}
    note right of OrderService: 트랜잭션 롤백
    deactivate OrderService
    Client --> User: "주문 실패" 메시지
    return
  end

  ' **핵심 결제 트랜잭션 시작 (DB 쓰기)**
  OrderService -> OrderDB: 주문 생성 (상태: PENDING)
  activate OrderDB
  OrderDB --> OrderService: 주문 ID 반환
  deactivate OrderDB

  loop 각 주문 상품
    OrderService -> ProductService: 상품 재고 감소 (productId, quantity)
    activate ProductService
    note right
      **재고 동시성 제어:**
      FOR UPDATE 또는 낙관적 락 고려
    end note
    ProductService --> OrderService: 재고 감소 결과 반환
    deactivate ProductService
  end

  OrderService -> BalanceService: 사용자 잔액 차감 (userId, finalAmount)
  activate BalanceService
  note right
    **잔액 동시성 제어:**
    FOR UPDATE 또는 낙관적 락 고려
  end note
  BalanceService --> OrderService: 잔액 차감 결과 반환
  deactivate BalanceService

  alt 쿠폰이 사용된 경우
    OrderService -> CouponService: 쿠폰 사용 처리 (userCouponId)
    activate CouponService
    CouponService --> OrderService: 쿠폰 사용 처리 결과 반환
    deactivate CouponService
  end

  OrderService -> OrderDB: 주문 상태 업데이트 (PENDING -> PAID)
  activate OrderDB
  OrderDB --> OrderService: 업데이트 결과 반환
  deactivate OrderDB

  note right of OrderService: **트랜잭션 커밋**

  OrderService --> Client: HTTP 200 OK \n{status: "SUCCESS", message: "주문 및 결제가 성공적으로 완료되었습니다!", data: {order_id: 123, final_amount: finalAmount}}

  ' 4. 데이터 분석 플랫폼으로 주문 정보 전송
  OrderService -> DataPlatformAdapter: 주문 정보 전송 요청
  activate DataPlatformAdapter
  note right of DataPlatformAdapter
    Mock API 또는 Fake Module 가정.
    전송 실패 시 재시도/DLQ 메커니즘 고려 필요.
  end note
  DataPlatformAdapter -> DataPlatform: 주문 정보 전달
  deactivate DataPlatformAdapter

end

alt **예상치 못한 내부 시스템 오류**
  note over OrderService
    비즈니스 로직 오류가 아닌
    DB 연결 문제 등 예측 불가능한 시스템 오류
  end note
  OrderService --> Client: HTTP 500 Internal Server Error \n{status: "FAIL", code: "INTERNAL_SERVER_ERROR", message: "주문 처리 중 서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요."}
  note right of OrderService: 트랜잭션 롤백
end

deactivate OrderService
Client --> User: 주문 완료 메시지 또는 오류 메시지
@enduml